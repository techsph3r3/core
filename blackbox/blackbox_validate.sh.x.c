#if 0
	shc Version 3.8.9b, Generic Script Compiler
	Copyright (c) 1994-2015 Francisco Rosales <frosal@fi.upm.es>

	shc -v -f blackbox_validate.sh 
#endif

static  char data [] = 
#define      shll_z	8
#define      shll	((&data[2]))
	"\146\152\212\347\017\002\025\265\131\112"
#define      date_z	1
#define      date	((&data[10]))
	"\242"
#define      pswd_z	256
#define      pswd	((&data[53]))
	"\010\145\015\253\355\045\204\121\035\037\371\046\272\351\224\206"
	"\175\262\112\166\353\040\225\122\212\271\166\255\301\033\360\312"
	"\201\375\166\156\042\372\277\100\032\271\226\123\211\366\121\120"
	"\364\351\212\322\314\300\242\367\171\377\364\070\375\246\015\021"
	"\050\263\235\236\313\321\221\063\012\047\207\223\036\331\343\022"
	"\303\156\345\217\057\210\207\251\207\174\341\205\042\356\226\112"
	"\242\063\350\156\005\172\241\017\242\051\242\300\003\206\323\306"
	"\365\270\126\044\100\335\315\310\131\257\115\174\235\343\306\100"
	"\027\256\256\034\051\120\054\313\172\316\214\175\125\137\103\112"
	"\030\231\157\131\167\075\041\321\354\157\115\212\123\023\313\152"
	"\302\171\207\353\312\263\267\104\202\103\302\327\243\006\041\274"
	"\240\220\025\027\316\067\351\272\246\067\104\371\113\020\144\015"
	"\211\354\371\124\237\260\231\042\363\133\371\226\142\033\122\002"
	"\254\150\032\172\237\003\065\106\073\172\100\206\212\245\223\024"
	"\221\214\150\061\075\001\123\060\135\115\307\300\150\032\302\024"
	"\202\334\217\042\340\304\151\033\076\251\242\310\116\065\334\337"
	"\302\104\020\377\106\144\060\244\261\367\144\031\022\047\056\225"
	"\003\275\267\344\201\040\000\277\312\242\207\030\330\144\370\233"
	"\250\011\233\357\155\313\224\036\303\370\147\325\242\373\133\040"
	"\256\246\226\231\306\054\353\121\345\141\376"
#define      msg2_z	19
#define      msg2	((&data[328]))
	"\161\376\050\220\017\147\044\356\244\055\276\353\045\060\267\120"
	"\175\347\147\222\137\354\347\155\017"
#define      tst2_z	19
#define      tst2	((&data[351]))
	"\261\135\132\245\230\074\212\251\137\244\256\016\014\150\365\257"
	"\156\334\205\374"
#define      chk2_z	19
#define      chk2	((&data[374]))
	"\210\262\055\256\324\011\305\217\030\072\025\040\350\223\102\100"
	"\103\204\113\312\014\371\250\140\323\076"
#define      msg1_z	42
#define      msg1	((&data[403]))
	"\345\352\120\107\351\367\046\107\141\027\135\154\114\075\246\361"
	"\300\010\353\061\251\271\137\171\036\271\325\273\263\316\367\322"
	"\013\236\243\135\034\341\021\050\353\136\101\270\331\202\171\355"
	"\304\327\151\303"
#define      opts_z	1
#define      opts	((&data[449]))
	"\344"
#define      text_z	1143
#define      text	((&data[507]))
	"\043\060\102\332\001\313\214\056\163\355\002\262\346\233\035\314"
	"\206\155\023\157\145\330\107\317\234\013\040\315\337\123\052\002"
	"\203\155\335\205\070\151\264\254\127\266\137\075\122\174\012\331"
	"\352\035\110\117\366\217\036\222\233\220\230\177\221\136\130\325"
	"\040\212\170\002\152\025\140\204\037\125\302\042\303\135\163\020"
	"\051\020\222\134\271\224\015\323\074\244\162\167\266\002\252\307"
	"\227\131\047\066\367\371\164\076\142\010\025\213\323\365\126\013"
	"\225\060\344\141\123\076\013\055\114\017\356\004\152\021\241\323"
	"\256\235\241\167\070\053\107\163\277\135\050\323\226\033\255\057"
	"\150\301\002\050\031\023\142\266\123\117\110\057\251\257\310\024"
	"\173\025\220\022\134\124\140\305\063\266\225\350\335\344\014\347"
	"\363\320\036\066\255\117\173\170\217\010\230\200\362\234\151\123"
	"\065\316\342\046\017\207\312\006\244\272\354\342\353\225\237\306"
	"\162\273\051\144\127\264\233\140\304\035\341\274\222\223\130\270"
	"\263\204\010\101\353\360\107\074\162\203\167\237\276\346\170\364"
	"\253\213\215\102\113\314\271\226\352\264\224\023\177\210\275\270"
	"\057\265\211\300\321\150\277\357\334\340\067\023\306\102\145\343"
	"\273\337\122\072\243\317\203\145\175\167\350\056\002\006\124\333"
	"\016\045\137\055\245\214\040\311\320\116\215\317\251\233\066\144"
	"\377\323\022\367\016\354\316\236\313\170\324\143\363\117\154\051"
	"\001\364\016\252\351\376\060\105\312\076\164\330\322\254\035\344"
	"\113\055\375\253\260\241\334\342\251\233\147\147\047\065\133\271"
	"\356\377\262\047\222\233\117\144\272\035\012\262\255\236\377\050"
	"\174\057\153\042\232\034\016\014\025\255\146\146\351\125\053\240"
	"\374\167\145\343\377\043\332\350\240\250\254\151\167\172\112\304"
	"\206\046\027\060\073\320\070\022\042\037\316\137\313\152\353\277"
	"\376\270\345\151\136\220\052\235\072\346\335\327\014\204\161\203"
	"\263\337\256\024\373\112\220\111\373\337\202\313\037\156\025\017"
	"\024\235\375\156\010\112\335\275\345\106\304\362\374\070\315\055"
	"\051\102\054\003\072\065\011\302\000\152\116\163\362\300\120\307"
	"\375\235\345\137\230\065\272\266\351\326\330\236\220\047\107\272"
	"\314\275\146\233\021\056\054\143\067\060\360\200\341\333\070\021"
	"\201\254\255\072\177\230\050\251\227\033\003\067\352\274\271\235"
	"\125\310\266\123\363\336\327\061\067\276\156\121\244\367\172\373"
	"\165\310\167\073\224\125\107\261\253\254\116\045\245\257\363\010"
	"\173\234\105\154\210\120\014\114\325\221\074\341\141\313\323\236"
	"\333\337\165\366\032\031\226\210\333\121\360\001\051\125\364\222"
	"\367\365\252\317\375\333\145\012\124\126\000\045\313\211\330\340"
	"\003\306\277\215\166\156\177\253\047\307\363\344\376\077\234\350"
	"\344\072\166\143\274\366\357\042\057\274\107\256\072\152\107\073"
	"\375\055\076\161\141\050\124\252\261\120\166\304\064\011\035\347"
	"\000\025\006\310\132\152\115\273\335\050\102\126\031\100\023\147"
	"\221\244\001\102\306\224\115\251\236\317\244\076\031\253\027\112"
	"\252\377\151\044\140\307\222\343\322\301\261\352\305\302\316\045"
	"\336\240\327\110\205\062\034\061\006\265\116\331\367\243\002\306"
	"\300\246\011\047\247\212\354\327\207\053\335\105\247\076\050\032"
	"\352\301\360\173\024\047\017\327\334\010\317\147\106\105\215\115"
	"\034\006\204\162\330\134\146\063\364\241\377\212\224\264\173\246"
	"\210\120\155\001\172\146\033\106\014\045\352\346\131\006\374\223"
	"\063\001\330\375\206\133\076\351\010\142\225\145\036\143\075\331"
	"\125\313\366\003\153\032\362\235\061\212\274\324\051\202\313\064"
	"\301\222\313\353\334\127\130\147\077\252\325\001\372\213\335\274"
	"\210\225\362\346\320\321\265\130\270\204\071\325\265\116\257\274"
	"\237\274\244\266\136\231\117\051\226\022\113\150\334\071\320\155"
	"\111\210\044\015\304\347\136\227\021\304\014\061\231\106\266\056"
	"\007\217\350\167\352\101\073\105\006\152\115\170\144\203\030\363"
	"\062\137\175\233\035\145\225\222\062\130\302\141\152\173\351\160"
	"\007\333\350\345\210\137\100\300\112\220\020\054\170\053\300\311"
	"\377\142\071\175\256\113\142\036\305\136\315\052\351\072\101\013"
	"\002\117\141\177\154\105\232\175\206\201\276\122\177\272\260\232"
	"\306\152\350\120\067\323\104\231\355\237\044\066\345\276\047\062"
	"\307\110\126\271\160\042\210\224\173\376\243\314\352\031\352\002"
	"\034\357\077\057\063\263\027\102\223\163\022\357\221\040\373\213"
	"\351\153\040\033\170\127\205\236\135\104\302\157\142\103\250\223"
	"\127\133\304\074\276\046\275\126\025\121\137\314\235\274\245\334"
	"\352\162\326\121\101\165\147\320\162\311\306\322\160\242\371\057"
	"\370\076\377\112\063\176\355\136\171\371\031\251\313\050\065\265"
	"\373\162\216\312\123\177\270\376\150\237\164\232\242\126\166\036"
	"\355\114\066\001\077\057\100\025\307\123\136\336\237\055\245\265"
	"\204\011\073\140\056\317\266\161\010\330\130\036\023\307\170\103"
	"\236\106\212\104\035\227\051\324\245\053\247\010\057\017\234\152"
	"\253\320\064\370\167\070\025\064\171\134\103\253\000\001\163\371"
	"\062\001\104\316\150\066\231\310\243\046\001\353\330\217\331\222"
	"\340\035\266\207\073\031\051\043\037\202\224\274\043\021\114\105"
	"\072\321\036\357\035\032\322\003\031\176\313\276\345\037\115\111"
	"\077\140\172\223\212\175\027\370\132\234\061\304\121\336\033\010"
	"\075\131\132\271\143\063\243\201\174\363\167\014\022\011\247\121"
	"\152\041\345\364\237\374\355\371\230\037\275\352\375\330\362\072"
	"\061\115\364\225\200\227\026\375\213\215\011\236\227\260\360\001"
	"\322\325\366\161\321\344\153\152\003\050\124\000\001\107\073\063"
	"\224\057\311\025\307\337\022\123\155\033\361\004\314\341\006\236"
	"\267\375\020\211\341\174\363\344"
#define      rlax_z	1
#define      rlax	((&data[1754]))
	"\274"
#define      inlo_z	3
#define      inlo	((&data[1755]))
	"\237\336\357"
#define      xecc_z	15
#define      xecc	((&data[1758]))
	"\136\247\107\113\223\337\330\310\362\066\000\222\246\164\170\243"
#define      lsto_z	1
#define      lsto	((&data[1774]))
	"\113"
#define      tst1_z	22
#define      tst1	((&data[1777]))
	"\146\134\164\006\063\337\067\014\331\071\225\154\172\161\245\364"
	"\232\034\252\206\111\267\111\051\365\063\076\373\322"
#define      chk1_z	22
#define      chk1	((&data[1809]))
	"\176\332\136\162\277\141\061\212\050\204\000\155\237\037\364\243"
	"\131\135\002\154\070\013\155\307\162\030\250\003\272\245\252\112"/* End of data[] */;
#define      hide_z	4096
#define DEBUGEXEC	0	/* Define as 1 to debug execvp calls */
#define TRACEABLE	0	/* Define as 1 to enable ptrace the executable */

/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/* 'Alleged RC4' */

static unsigned char stte[256], indx, jndx, kndx;

/*
 * Reset arc4 stte. 
 */
void stte_0(void)
{
	indx = jndx = kndx = 0;
	do {
		stte[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = stte[indx];
			kndx += tmp;
			kndx += ptr[(int)indx % len];
			stte[indx] = stte[kndx];
			stte[kndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void arc4(void * str, int len)
{
	unsigned char tmp, * ptr = (unsigned char *)str;
	while (len > 0) {
		indx++;
		tmp = stte[indx];
		jndx += tmp;
		stte[indx] = stte[jndx];
		stte[jndx] = tmp;
		tmp += stte[indx];
		*ptr ^= stte[tmp];
		ptr++;
		len--;
	}
}

/* End of ARC4 */

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key(control, sizeof(control));
	return 0;
}

#if DEBUGEXEC
void debugexec(char * sh11, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", sh11 ? sh11 : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}
#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

int chkenv(int argc)
{
	char buff[512];
	unsigned long mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask  = (unsigned long)&chkenv;
	mask ^= (unsigned long)getpid() * ~mask;
	sprintf(buff, "x%lx", mask);
	string = getenv(buff);
#if DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%lu %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%lu %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

#if !TRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

#if !defined(PTRACE_ATTACH) && defined(PT_ATTACH)
#	define PTRACE_ATTACH	PT_ATTACH
#endif
void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = fork()) {
	case  0:
		pid = getppid();
		/* For problematic SunOS ptrace */
#if defined(__FreeBSD__)
		sprintf(proc, "/proc/%d/mem", (int)pid);
#else
		sprintf(proc, "/proc/%d/as",  (int)pid);
#endif
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PTRACE_ATTACH, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			perror(argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif /* !TRACEABLE */

char * xsh(int argc, char ** argv)
{
	char * scrpt;
	int ret, i, j;
	char ** varg;
	char * me = argv[0];

	stte_0();
	 key(pswd, pswd_z);
	arc4(msg1, msg1_z);
	arc4(date, date_z);
	if (date[0] && (atoll(date)<time(NULL)))
		return msg1;
	arc4(shll, shll_z);
	arc4(inlo, inlo_z);
	arc4(xecc, xecc_z);
	arc4(lsto, lsto_z);
	arc4(tst1, tst1_z);
	 key(tst1, tst1_z);
	arc4(chk1, chk1_z);
	if ((chk1_z != tst1_z) || memcmp(tst1, chk1, tst1_z))
		return tst1;
	ret = chkenv(argc);
	arc4(msg2, msg2_z);
	if (ret < 0)
		return msg2;
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		arc4(rlax, rlax_z);
		if (!rlax[0] && key_with_file(shll))
			return shll;
		arc4(opts, opts_z);
		arc4(text, text_z);
		arc4(tst2, tst2_z);
		 key(tst2, tst2_z);
		arc4(chk2, chk2_z);
		if ((chk2_z != tst2_z) || memcmp(tst2, chk2, tst2_z))
			return tst2;
		/* Prepend hide_z spaces to script text to hide it. */
		scrpt = malloc(hide_z + text_z);
		if (!scrpt)
			return 0;
		memset(scrpt, (int) ' ', hide_z);
		memcpy(&scrpt[hide_z], text, text_z);
	} else {			/* Reexecute */
		if (*xecc) {
			scrpt = malloc(512);
			if (!scrpt)
				return 0;
			sprintf(scrpt, xecc, me);
		} else {
			scrpt = me;
		}
	}
	j = 0;
	varg[j++] = argv[0];		/* My own name at execution */
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#if DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#if DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#if !TRACEABLE
	untraceable(argv[0]);
#endif
	argv[1] = xsh(argc, argv);
	fprintf(stderr, "%s%s%s: %s\n", argv[0],
		errno ? ": " : "",
		errno ? strerror(errno) : "",
		argv[1] ? argv[1] : "<null>"
	);
	return 1;
}
