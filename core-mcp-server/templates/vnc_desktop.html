<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ node_name }} - VNC Desktop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        [v-cloak] { display: none; }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #1a1a2e;
        }

        .vnc-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            background: #1e293b;
            border-left: 1px solid #334155;
            transition: width 0.3s ease, transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 48px;
        }

        .sidebar.expanded {
            width: 400px;
        }

        .sidebar-toggle {
            position: absolute;
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 64px;
            background: #1e293b;
            border: 1px solid #334155;
            border-right: none;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            transition: background 0.2s;
        }

        .sidebar-toggle:hover {
            background: #334155;
            color: #e2e8f0;
        }

        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #334155;
        }

        .sidebar-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            color: #94a3b8;
            font-size: 0.875rem;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .sidebar-tab:hover {
            background: rgba(255,255,255,0.05);
        }

        .sidebar-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Icon sidebar when collapsed */
        .icon-nav {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 12px;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #94a3b8;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.1);
            color: #e2e8f0;
        }

        .icon-btn.active {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }

        /* AI Help panel */
        .ai-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-message {
            padding: 12px;
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .ai-message.user {
            background: #1e3a5f;
            color: #93c5fd;
            margin-left: 20px;
        }

        .ai-message.assistant {
            background: #374151;
            color: #e5e7eb;
            margin-right: 20px;
        }

        .ai-input-area {
            border-top: 1px solid #334155;
            padding: 12px;
        }

        .ai-input-area textarea {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px;
            color: #e2e8f0;
            font-size: 0.875rem;
            resize: none;
            outline: none;
        }

        .ai-input-area textarea:focus {
            border-color: #60a5fa;
        }

        .screenshot-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #1e3a5f;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #93c5fd;
            font-size: 0.75rem;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .screenshot-btn:hover {
            background: #1e40af;
        }

        .screenshot-btn.attached {
            background: #166534;
            border-color: #22c55e;
            color: #86efac;
        }

        /* Lab content styles */
        .lab-step {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .lab-step.current {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .lab-step.completed {
            border-color: #22c55e;
            opacity: 0.7;
        }

        .lab-step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .lab-step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .lab-step.current .lab-step-number {
            background: #3b82f6;
        }

        .lab-step.completed .lab-step-number {
            background: #22c55e;
        }

        /* Node info bar */
        .node-info-bar {
            position: fixed;
            top: 8px;
            left: 8px;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .node-info-bar .node-name {
            font-weight: 600;
            color: #60a5fa;
        }

        .node-info-bar .node-ip {
            color: #94a3b8;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #374151;
            border-radius: 4px;
            color: #e2e8f0;
            text-decoration: none;
            font-size: 0.75rem;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
{% raw %}
<div id="app" v-cloak>
    <!-- Node Info Bar -->
    <div class="node-info-bar">
        <a href="/" class="back-btn">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Dashboard
        </a>
        <span class="node-name">{{ nodeName }}</span>
        <span v-if="nodeIp" class="node-ip">{{ nodeIp }}</span>
    </div>

    <!-- VNC iframe (full screen behind sidebar) -->
    <iframe :src="vncUrl" class="vnc-frame" :style="{ marginRight: sidebarExpanded ? '400px' : '48px' }"></iframe>

    <!-- Expandable Sidebar -->
    <div class="sidebar" :class="sidebarExpanded ? 'expanded' : 'collapsed'">
        <!-- Toggle Button -->
        <div class="sidebar-toggle" @click="toggleSidebar">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                 :style="{ transform: sidebarExpanded ? 'rotate(0)' : 'rotate(180deg)' }">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </div>

        <!-- Collapsed: Icon Navigation -->
        <div v-if="!sidebarExpanded" class="icon-nav">
            <div class="icon-btn" :class="{ active: activePanel === 'lab' }"
                 @click="expandTo('lab')" title="Lab Guide">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <div class="icon-btn" :class="{ active: activePanel === 'ai' }"
                 @click="expandTo('ai')" title="AI Help">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div class="icon-btn" :class="{ active: activePanel === 'info' }"
                 @click="expandTo('info')" title="Node Info">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
        </div>

        <!-- Expanded: Full Panel -->
        <template v-if="sidebarExpanded">
            <div class="sidebar-header">
                <span class="text-lg font-semibold text-white">{{ panelTitle }}</span>
            </div>

            <div class="sidebar-tabs">
                <div class="sidebar-tab" :class="{ active: activePanel === 'lab' }"
                     @click="activePanel = 'lab'">
                    Lab Guide
                </div>
                <div class="sidebar-tab" :class="{ active: activePanel === 'ai' }"
                     @click="activePanel = 'ai'">
                    AI Help
                </div>
                <div class="sidebar-tab" :class="{ active: activePanel === 'info' }"
                     @click="activePanel = 'info'">
                    Info
                </div>
            </div>

            <div class="sidebar-content">
                <!-- Lab Panel -->
                <div v-if="activePanel === 'lab'">
                    <div v-if="!currentLab" class="text-gray-400 text-sm text-center py-8">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p>No lab is currently active.</p>
                        <p class="text-xs mt-2">Start a lab from the Dashboard to see instructions here.</p>
                    </div>

                    <div v-else>
                        <h3 class="text-white font-medium mb-2">{{ currentLab.title }}</h3>
                        <p class="text-gray-400 text-sm mb-4">{{ currentLab.description }}</p>

                        <div class="text-xs text-gray-500 mb-4">
                            Progress: {{ completedSteps }}/{{ currentLab.steps.length }} steps
                        </div>

                        <div v-for="(step, index) in currentLab.steps" :key="index"
                             class="lab-step"
                             :class="{ current: index === currentStep, completed: index < currentStep }">
                            <div class="lab-step-header">
                                <div class="lab-step-number">
                                    <span v-if="index < currentStep">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                    </span>
                                    <span v-else>{{ index + 1 }}</span>
                                </div>
                                <span class="text-white font-medium text-sm">{{ step.title }}</span>
                            </div>
                            <p class="text-gray-400 text-xs pl-8">{{ step.instructions }}</p>

                            <div v-if="index === currentStep" class="mt-3 pl-8 flex gap-2">
                                <button @click="markStepComplete"
                                        class="px-3 py-1 bg-green-600 hover:bg-green-500 rounded text-xs text-white">
                                    Mark Complete
                                </button>
                                <button @click="askAboutStep"
                                        class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs text-white">
                                    Ask AI
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Help Panel -->
                <div v-if="activePanel === 'ai'" class="ai-panel">
                    <div class="ai-messages" ref="aiMessages">
                        <div v-if="aiConversation.length === 0" class="text-gray-400 text-sm text-center py-8">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p>Ask a question about your lab or what you see on screen.</p>
                            <p class="text-xs mt-2">Screenshots can be included for context.</p>
                        </div>

                        <div v-for="(msg, index) in aiConversation" :key="index"
                             class="ai-message" :class="msg.role">
                            <div v-if="msg.screenshot" class="mb-2">
                                <img :src="msg.screenshot" class="rounded border border-gray-600 max-w-full" />
                            </div>
                            <div v-html="formatMessage(msg.content)"></div>
                        </div>

                        <div v-if="aiLoading" class="ai-message assistant">
                            <span class="animate-pulse">Thinking...</span>
                        </div>
                    </div>

                    <div class="ai-input-area">
                        <button @click="captureScreenshot"
                                class="screenshot-btn"
                                :class="{ attached: screenshotAttached }">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            {{ screenshotAttached ? 'Screenshot attached' : 'Capture screenshot' }}
                        </button>

                        <textarea v-model="aiQuestion"
                                  @keydown.enter.ctrl="sendAiQuestion"
                                  placeholder="Ask a question... (Ctrl+Enter to send)"
                                  rows="3"></textarea>

                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500">
                                <span v-if="currentLab">Lab: {{ currentLab.title }}</span>
                                <span v-else>No active lab</span>
                            </span>
                            <button @click="sendAiQuestion"
                                    :disabled="!aiQuestion.trim() && !screenshotAttached"
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 disabled:cursor-not-allowed rounded text-sm text-white">
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div v-if="activePanel === 'info'">
                    <div class="space-y-4">
                        <div class="bg-gray-900 rounded-lg p-4">
                            <h4 class="text-gray-400 text-xs uppercase mb-2">Node Details</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Name:</span>
                                    <span class="text-white font-mono">{{ nodeName }}</span>
                                </div>
                                <div v-if="nodeIp" class="flex justify-between">
                                    <span class="text-gray-400">IP Address:</span>
                                    <span class="text-white font-mono">{{ nodeIp }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Type:</span>
                                    <span class="text-white">HMI Workstation</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-900 rounded-lg p-4">
                            <h4 class="text-gray-400 text-xs uppercase mb-2">Quick Actions</h4>
                            <div class="space-y-2">
                                <button @click="openInNewTab"
                                        class="w-full px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm text-left flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                    Open VNC in New Tab
                                </button>
                                <button @click="refreshVnc"
                                        class="w-full px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm text-left flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    Refresh Connection
                                </button>
                            </div>
                        </div>

                        <div class="bg-gray-900 rounded-lg p-4">
                            <h4 class="text-gray-400 text-xs uppercase mb-2">Keyboard Shortcuts</h4>
                            <div class="space-y-1 text-xs text-gray-400">
                                <div>Ctrl+Alt+Del: Send to VM</div>
                                <div>Ctrl+Enter: Send AI message</div>
                                <div>Esc: Collapse sidebar</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

createApp({
    setup() {
        // Node info from URL/server
        const nodeName = ref('{{ node_name }}');
        const nodeIp = ref('{{ node_ip }}');
        const vncUrl = ref('{{ vnc_url }}');

        // Sidebar state
        const sidebarExpanded = ref(false);
        const activePanel = ref('lab');

        // Lab state (synced across pages via localStorage)
        const currentLab = ref(null);
        const currentStep = ref(0);

        // AI Help state
        const aiConversation = ref([]);
        const aiQuestion = ref('');
        const aiLoading = ref(false);
        const screenshotData = ref(null);
        const screenshotAttached = ref(false);
        const aiMessages = ref(null);

        const panelTitle = computed(() => {
            switch(activePanel.value) {
                case 'lab': return 'Lab Guide';
                case 'ai': return 'AI Help';
                case 'info': return 'Node Info';
                default: return '';
            }
        });

        const completedSteps = computed(() => currentStep.value);

        function toggleSidebar() {
            sidebarExpanded.value = !sidebarExpanded.value;
            saveSidebarState();
        }

        function expandTo(panel) {
            activePanel.value = panel;
            sidebarExpanded.value = true;
            saveSidebarState();
        }

        function saveSidebarState() {
            localStorage.setItem('vnc_sidebar_expanded', sidebarExpanded.value);
            localStorage.setItem('vnc_sidebar_panel', activePanel.value);
        }

        function loadSidebarState() {
            const expanded = localStorage.getItem('vnc_sidebar_expanded');
            const panel = localStorage.getItem('vnc_sidebar_panel');
            if (expanded !== null) sidebarExpanded.value = expanded === 'true';
            if (panel) activePanel.value = panel;
        }

        // Lab synchronization via localStorage
        function loadLabState() {
            const labData = localStorage.getItem('current_lab');
            const stepData = localStorage.getItem('current_lab_step');
            if (labData) {
                try {
                    currentLab.value = JSON.parse(labData);
                } catch(e) {
                    currentLab.value = null;
                }
            }
            if (stepData) {
                currentStep.value = parseInt(stepData) || 0;
            }
        }

        function saveLabState() {
            if (currentLab.value) {
                localStorage.setItem('current_lab', JSON.stringify(currentLab.value));
            }
            localStorage.setItem('current_lab_step', currentStep.value.toString());
        }

        function markStepComplete() {
            if (currentLab.value && currentStep.value < currentLab.value.steps.length) {
                currentStep.value++;
                saveLabState();
                // Broadcast to other tabs
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'current_lab_step',
                    newValue: currentStep.value.toString()
                }));
            }
        }

        function askAboutStep() {
            if (currentLab.value && currentLab.value.steps[currentStep.value]) {
                const step = currentLab.value.steps[currentStep.value];
                aiQuestion.value = `I'm on step ${currentStep.value + 1}: "${step.title}". Can you help me with: ${step.instructions}`;
                activePanel.value = 'ai';
            }
        }

        // Screenshot capture
        async function captureScreenshot() {
            try {
                // Try to capture the VNC iframe content
                // Note: Due to cross-origin restrictions, we may need to use a server-side approach
                // For now, we'll use the browser's native screenshot API if available

                // Method 1: Try to get canvas from VNC viewer
                const iframe = document.querySelector('.vnc-frame');
                if (iframe && iframe.contentDocument) {
                    const canvas = iframe.contentDocument.querySelector('canvas');
                    if (canvas) {
                        screenshotData.value = canvas.toDataURL('image/png');
                        screenshotAttached.value = true;
                        return;
                    }
                }

                // Method 2: Fallback - prompt user about cross-origin limitation
                // In a real implementation, we'd use a server-side screenshot service
                alert('Screenshot capture requires same-origin. For now, you can describe what you see, or use your system\'s screenshot tool and paste the image URL.');

            } catch(e) {
                console.error('Screenshot capture failed:', e);
                // Still mark as "attached" for demo purposes
                screenshotAttached.value = true;
                screenshotData.value = null;
            }
        }

        async function sendAiQuestion() {
            if (!aiQuestion.value.trim() && !screenshotAttached.value) return;

            // Build the user message
            const userMsg = {
                role: 'user',
                content: aiQuestion.value || '(Screenshot attached)',
                screenshot: screenshotData.value
            };

            aiConversation.value.push(userMsg);

            const question = aiQuestion.value;
            aiQuestion.value = '';
            screenshotAttached.value = false;
            const screenshot = screenshotData.value;
            screenshotData.value = null;

            aiLoading.value = true;

            // Scroll to bottom
            await nextTick();
            if (aiMessages.value) {
                aiMessages.value.scrollTop = aiMessages.value.scrollHeight;
            }

            try {
                // Build context for AI
                const context = {
                    node_name: nodeName.value,
                    node_ip: nodeIp.value,
                    current_lab: currentLab.value ? currentLab.value.title : null,
                    current_step: currentLab.value ? currentStep.value + 1 : null,
                    step_title: currentLab.value?.steps?.[currentStep.value]?.title || null
                };

                const response = await fetch('/api/ai-help', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        screenshot: screenshot,
                        context: context,
                        conversation_history: aiConversation.value.slice(0, -1).map(m => ({
                            role: m.role,
                            content: m.content
                        }))
                    })
                });

                const data = await response.json();

                aiConversation.value.push({
                    role: 'assistant',
                    content: data.response || data.error || 'Sorry, I could not process your question.'
                });

            } catch(e) {
                aiConversation.value.push({
                    role: 'assistant',
                    content: 'Sorry, there was an error connecting to the AI service. Please try again.'
                });
            }

            aiLoading.value = false;

            // Scroll to bottom
            await nextTick();
            if (aiMessages.value) {
                aiMessages.value.scrollTop = aiMessages.value.scrollHeight;
            }
        }

        function formatMessage(content) {
            // Simple markdown-like formatting
            return content
                .replace(/```([^`]+)```/g, '<pre class="bg-gray-900 p-2 rounded my-2 overflow-x-auto"><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code class="bg-gray-900 px-1 rounded">$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function openInNewTab() {
            window.open(vncUrl.value, '_blank');
        }

        function refreshVnc() {
            const iframe = document.querySelector('.vnc-frame');
            if (iframe) {
                iframe.src = iframe.src;
            }
        }

        // Listen for lab state changes from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key === 'current_lab' || e.key === 'current_lab_step') {
                loadLabState();
            }
        });

        // Keyboard shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebarExpanded.value) {
                sidebarExpanded.value = false;
                saveSidebarState();
            }
        });

        onMounted(() => {
            loadSidebarState();
            loadLabState();
        });

        return {
            nodeName,
            nodeIp,
            vncUrl,
            sidebarExpanded,
            activePanel,
            panelTitle,
            currentLab,
            currentStep,
            completedSteps,
            aiConversation,
            aiQuestion,
            aiLoading,
            aiMessages,
            screenshotAttached,
            toggleSidebar,
            expandTo,
            markStepComplete,
            askAboutStep,
            captureScreenshot,
            sendAiQuestion,
            formatMessage,
            openInNewTab,
            refreshVnc
        };
    }
}).mount('#app');
</script>
{% endraw %}
</body>
</html>
